#bash 
cat > sendmessage.json <<'EOF'
{
  "body": {
    "contentType": "html",
    "content": "Hello from Codespaces ğŸ‘‹"
  }
}
EOF

# bash
JOIN_URL='https://teams.microsoft.com/l/meetup-join/19%3ameeting_OWI4YmNlMTUtYjc4Ni00MGI3LWIzYTQtMzI3NGY5MzUwOGZj%40thread.v2/0?context=...'

ENCODED_JOIN_URL=$(python3 -c "import urllib.parse,os;print(urllib.parse.quote(os.environ['JOIN_URL'], safe=''))" )

THREAD_ID=$(curl -s -X GET "https://graph.microsoft.com/v1.0/me/onlineMeetings?\$filter=joinWebUrl%20eq%20'${ENCODED_JOIN_URL}'" \
  -H "Authorization: Bearer HAVETOKEN-XYZ12345" \
  -H "Accept: application/json" \
  | jq -r '.value[0].chatInfo.threadId')

echo "threadId: $THREAD_ID"

# bash
curl -X POST "https://graph.microsoft.com/v1.0/chats/$THREAD_ID/messages" \
  -H "Authorization: Bearer HAVETOKEN-XYZ12345" \
  -H "Content-Type: application/json" \
  -d @sendmessage.json


#Option2
# base
THREAD_ID=$(
  curl -s -G "https://graph.microsoft.com/v1.0/me/onlineMeetings" \
    --data-urlencode "\$filter=joinWebUrl eq '${JOIN_URL}'" \
    -H "Authorization: Bearer $GRAPH_TOKEN" \
    -H "Accept: application/json" \
  | jq -r '.value[0].chatInfo.threadId'
)

echo "threadId: $THREAD_ID"

# bash message send all in one
MSG="Hello from Codespaces ğŸ‘‹"
curl -s -X POST "https://graph.microsoft.com/v1.0/chats/$THREAD_ID/messages" \
  -H "Authorization: Bearer $GRAPH_TOKEN" \
  -H "Content-Type: application/json" \
  -d "$(jq -n --arg msg "$MSG" '{body:{contentType:"html", content:$msg}}')"
